<!DOCTYPE html>
<html>
<head>

  <title>Netlify OrbitDB Demo</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <!-- Optional Bootstrap theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

  <link href="styling.css" rel="stylesheet" type="text/css">

</head>
<body>
  <h1>OrbitDB client served by Netlify!</h1>
  Any name you want will create the database for you.
  <br/>
  <br/>

  <input id="dbname" type="text" placeholder="Database name" />
  <button id="open" type="button" class="btn btn-primary">Open</button>
  <br><br>
  <div id="output"></div>

  <script src="live.js" type="text/javascript" ></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


  <script type="text/javascript" src="lib/orbitdb.min.js" charset="utf-8"></script>
  <script type="text/javascript" src="lib/ipfs-browser-daemon.min.js" charset="utf-8"></script>

  <script type="text/javascript">
    const elm = document.getElementById("output")
    const dbnameField = document.getElementById("dbname")
    const openButton = document.getElementById("open")

    const openDatabase = () => {
      openButton.disabled = true
      elm.innerHTML = "Starting IPFS..."

      const dbname = dbnameField.value
      const username = new Date().getTime()
      const key = 'greeting'

      const ipfs = new IpfsDaemon({
        IpfsDataDir: '/orbit-db-/examples/browser',
        SignalServer: 'star-signal.cloud.ipfs.team', // IPFS dev server
      })

      function handleError(e) {
        console.error(e.stack)
        elm.innerHTML = e.message
      }

      ipfs.on('error', (e) => handleError(e))

      ipfs.on('ready', () => {
        elm.innerHTML = "Loading database..."

        const orbit = new OrbitDB(ipfs, username)

        const db = orbit.kvstore(dbname, { maxHistory: 5, syncHistory: false, cachePath: '/orbit-db' })
        const log = orbit.eventlog(dbname + ".log", { maxHistory: 5, syncHistory: false, cachePath: '/orbit-db' })
        const counter = orbit.counter(dbname + ".count", { maxHistory: 5, syncHistory: false, cachePath: '/orbit-db' })

        const creatures = ['👻', '🐙', '🐷', '🐬', '🐞', '🐈', '🙉', '🐸', '🐓']
        const idx = Math.floor(Math.random() * creatures.length)
        const creature = creatures[idx]

        const interval = Math.floor((Math.random() * 5000) + 3000)

        let count = 0
        const query = () => {
          const value = "GrEEtinGs from " + username + " " + creature + ": Hello #" + count + " (" + new Date().getTime() + ")"
          // Set a key-value pair
          count ++
          db.put(key, value)
            .then(() => counter.inc()) // Increase the counter by one
            .then(() => log.add(value)) // Add an event to 'latest visitors' log
            .then(() => getData())
            .catch((e) => handleError(e))
        }

        const getData = () => {
          const result = db.get(key)
          const latest = log.iterator({ limit: 5 }).collect()
          const count  = counter.value

          ipfs.pubsub.peers(dbname + ".log")
            .then((peers) => {
              const output = `
                <b>You are:</b> ${username} ${creature}<br>
                <b>Peers:</b> ${peers.length}<br>
                <b>Database:</b> ${dbname}<br>
                <br><b>Writing to database every ${interval} milliseconds...</b><br><br>
                <b>Key-Value Store</b>
                -------------------------------------------------------
                Key | Value
                -------------------------------------------------------
                ${key} | ${result}
                -------------------------------------------------------

                <b>Eventlog</b>
                -------------------------------------------------------
                Latest Updates
                -------------------------------------------------------
                ${latest.reverse().map((e) => e.payload.value).join('\n')}

                <b>Counter</b>
                -------------------------------------------------------
                Visitor Count: ${count}
                -------------------------------------------------------
                `
              elm.innerHTML = output.split("\n").join("<br>")
            })
        }

        db.events.on('synced', () => getData())
        counter.events.on('synced', () => getData())
        log.events.on('synced', () => getData())

        db.events.on('ready', () => getData())
        counter.events.on('ready', () => getData())
        log.events.on('ready', () => getData())

        // Start query loop when the databse has loaded its history
        db.load(10)
          .then(() => counter.load(10))
          .then(() => log.load(10))
          .then(() => {
            count = counter.value
            setInterval(query, interval)
          })
      })
    }

    openButton.addEventListener('click', openDatabase)
  </script>
</body>
</html>
